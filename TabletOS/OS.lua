local a=require("computer")local b=require("component")local c=b.gpu;local d=require("event")local e=require("ECSAPI")local f=require("term")local g=require("unicode")local h=require("filesystem")local i=require("TabletOSCore")local j=require("gui")_G.Math=math;local k={}local l=require("shell")local m={}f.clear()local n,o=c.getResolution()local function p()c.setBackground(0x610B5E)c.fill(1,25,80,1," ")c.set(40,25,"●")c.set(35,25,"◀")c.set(45,25,"▶")c.setBackground(0xFFFF00)c.setForeground(0x610B5E)c.set(1,25,"M")c.setBackground(0x000000)c.setForeground(0xFFFFFF)end;function executeTouch(q,r,s)for t=1,#s do if e.clickedAtArea(s.x1,s.y1,s.x2,s.y2,q,r)then local u,v=xpcall(s.callback,debug.traceback)return u,v end end end;local function w(x,y,z,A,q,r)if q>=x and q<=z and r>=y and r<=A then return true end;return false end;local B={}function drawMenu()local C={{y=20,name=i.getLanguagePackages().fileManager,callback=function()e.drawOldPixels(m)dofile("/apps/fileManager.lua")end},{y=21,name=i.getLanguagePackages().monitorOnline,callback=function()dofile("/apps/monitorOnline.lua")c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,70,1," ")c.setBackground(0x000000)c.fill(1,2,80,23," ")end},{y=22,name=i.getLanguagePackages().settings,callback=function()k.settings()c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,70,1," ")c.setBackground(0x000000)c.fill(1,2,80,23," ")end},{y=23,name=i.getLanguagePackages().reboot,callback=function()a.shutdown(true)end},{y=24,name=i.getLanguagePackages().shutdown,callback=function()a.shutdown()end}}local function D(y)for t=1,#C do if y==C[t].y then return true,C[t].callback end end;return false,function()return false end end;B=e.rememberOldPixels(1,10,15,24)local E=c.setBackground(0xFFFFFF)local F=c.setForeground(0x000000)c.fill(1,10,15,15," ")for t=1,#C do c.set(1,C[t].y,C[t].name)end;c.setForeground(F)c.setBackground(E)while true do local G={d.pull("touch")}if w(1,10,15,24,G[3],G[4])then local H,I=D(G[4])if H then e.drawOldPixels(m)local J=e.rememberOldPixels(1,1,80,25)I()e.drawOldPixels(J)drawWorkTable()break end else c.setForeground(0xFFFFFF)c.setBackground(0x000000)c.fill(1,10,10,15," ")e.drawOldPixels(B)B={}a.pushSignal(table.unpack(G))break end end end;local function K(L)local a=require("computer")local b=require("component")local c=b.gpu;local function centerText(y,M)local x=Math.floor(n/2-g.len(M)/2)c.set(x,y,M)end;c.setBackground(0x0000FF)c.fill(1,1,n,o," ")centerText(o/2,i.getLanguagePackages().logout)k=nil;_G=nil;io=nil;os=nil;package=nil;c.fill(1,1,80,25," ")centerText(o/2,i.getLanguagePackages().shutdownI)os.sleep(0.4)a.shutdown(L)end;function k.settings()c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.set(1,1,i.getLanguagePackages().settings)c.setBackground(0xCCCCCC)c.fill(1,2,80,23," ")c.setForeground(0xFFFFFF)c.set(1,2,i.getLanguagePackages().language)local N={}local O=false;local function P()N=e.rememberOldPixels(1,2,80,24)c.setBackground(0xCCCCCC)c.setForeground(0xFFFFFF)c.fill(1,2,80,23," ")centerText(2,i.getLanguagePackages().selLanguage)centerText(3,"English")centerText(4,"Русский")while true do local G={d.pull("touch")}if G[4]==3 then i.changeLanguage("en")c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,70,1," ")c.set(1,1,i.getLanguagePackages().settings)c.setBackground(0xCCCCCC)c.fill(1,2,80,23," ")c.setForeground(0xFFFFFF)c.set(1,2,i.getLanguagePackages().language)break elseif G[4]==4 then i.changeLanguage("ru")c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,70,1," ")c.set(1,1,i.getLanguagePackages().settings)c.setBackground(0xCCCCCC)c.fill(1,2,80,23," ")c.setForeground(0xFFFFFF)c.set(1,2,i.getLanguagePackages().language)e.drawOldPixels(N)break elseif G[3]==1 and G[4]==25 then drawMenu()startClickListenerM()elseif G[3]==40 and G[4]==25 then O=true;c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,70,1," ")c.set(1,1,i.getLanguagePackages().settings)c.setBackground(0xCCCCCC)c.fill(1,2,80,23," ")c.setForeground(0xFFFFFF)c.set(1,2,i.getLanguagePackages().language)e.drawOldPixels(N)break elseif G[3]==35 and G[4]==25 then c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,70,1," ")c.set(1,1,i.getLanguagePackages().settings)c.setBackground(0xCCCCCC)c.fill(1,2,80,23," ")c.setForeground(0xFFFFFF)c.set(1,2,i.getLanguagePackages().language)e.drawOldPixels(N)break end end end;while true do local G={d.pull("touch")}if G[3]==1 and G[4]==25 then drawMenu()startClickListenerM()elseif G[4]==2 then P()i.language=i.getLanguage()elseif G[3]==40 and G[4]==25 then break elseif G[3]==35 and G[4]==25 then break end;if O==true then break end;c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,77,1," ")local Q=i.getLanguagePackages().power;local R=g.len(Q)c.setBackground(0xFFFF00)c.setForeground(0x610B5E)c.set(76-R,1,Q)c.setBackground(0x000000)c.setForeground(0xFFFFFF)end end;_G.oldEnergy=100;local function S()local b=require("component")local c=b.gpu;local T=Math.floor(a.energy()/a.maxEnergy()*100)local U=string.gsub(string.format("%q",math.floor(a.energy()/a.maxEnergy()*100)),"\"","")local R=Math.floor(g.len(U)/2)local V=c.setBackground(0x610B5E)local W=c.setForeground(0xFFFFFF)c.set(79-R,1,U)c.set(80,1,"%")c.setBackground(V)c.setForeground(W)if T<6 then require("term").clear()print("Not enough energy! Shutdown tablet... ")require("computer").shutdown()end;if not T==oldEnergy then a.pushSignal("energyChange",oldEnergy,T)end;oldEnergy=T end;local function X()c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,80,1," ")local Q=i.getLanguagePackages().power;local R=g.len(Q)c.setBackground(0xFFFF00)c.setForeground(0x610B5E)c.set(76-R,1,Q)c.setBackground(0x000000)c.setForeground(0xFFFFFF)timerID=d.timer(1,S,math.huge)end;_G.workTable={}function drawWorkTable()workTable={}j.setColors(0x000000,0xFFFFFF)c.fill(1,2,80,23," ")local function Y()local Z="/usr/table/"h.makeDirectory(Z)local _={}for a0 in h.list(Z)do if h.exists(Z..a0)and not h.isDirectory(Z..a0)then table.insert(_,Z..a0)end end;return _ end;local _=Y()for t=1,#_ do local a1=math.ceil(t/8)+1;local n=10;local o=1;local a2=(t-1)*n+1-(a1-2)*n*8;local a3=a1;local a4=function()l.execute(_[t])end;local a5=math.random(0x000000,0xFFFFFF)local a6=0xFFFFFF-a5;j.drawButton(a2+1,a3,n,o,h.name(_[t]),a5,a6)local a7={x=a2,y=a3,w=n,h=o,callback=a4}table.insert(workTable,a7)end end;X()p()drawWorkTable()listener=function(...)local G={...}if G[3]==1 and G[4]==25 then m=e.rememberOldPixels(1,2,80,24)drawMenu()e.drawOldPixels(m)elseif G[3]==45 and G[4]==25 then d.cancel(timerID)f.clear()while true do local a8,v=xpcall(loadfile("/apps/shell.lua"),function(a9)return tostring(a9).."\n"..debug.traceback()end)if not a8 then io.stderr:write((v~=nil and tostring(v)or"unknown error").."\n")io.write("Press any key to continue.\n")os.sleep(0.5)require("event").pull("key")end end end;local Q=i.getLanguagePackages().power;local R=g.len(Q)if w(76-R,1,76,1,G[3],G[4])then local aa=e.rememberOldPixels(1,1,80,25)e.clearScreen(0x000000)e.waitForTouchOrClick()e.drawOldPixels(aa)end end;_G.eventListener=d.listen("touch",listener)while true do local G={d.pull("touch")}for t=1,#workTable do local ab=workTable[t]if w(ab.x,ab.y,ab.x+ab.w-1,ab.y+ab.h-1,G[3],G[4])then local u,v=i.saveDisplayAndCallFunction(ab.callback)if not u and v then d.cancel(timerID)d.ignore("touch",listener)i.saveDisplayAndCallFunction(e.error,v)timerID=d.timer(1,S,math.huge)eventListener=d.listen("touch",listener)end end end end
