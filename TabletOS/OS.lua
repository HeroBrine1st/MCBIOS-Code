local a=require("computer")local b=require("component")local c=b.gpu;local d=require("event")local e=require("ECSAPI")local f=require("term")local g=require("unicode")local h=require("filesystem")local i=require("TabletOSCore")local j=require("gui")_G.Math=math;local k={}local l=require("shell")local m={}f.clear()local n,o=c.getResolution()local function p()c.setBackground(0x610B5E)c.fill(1,25,80,1," ")c.set(40,25,"●")c.set(35,25,"◀")c.set(45,25,"▶")c.setBackground(0xFFFF00)c.setForeground(0x610B5E)c.set(1,25,"M")c.setBackground(0x000000)c.setForeground(0xFFFFFF)end;local function q(r,s,t,u,v,w)if v>=r and v<=t and w>=s and w<=u then return true end;return false end;local x={}function drawMenu()local y={{y=19,name=i.getLanguagePackages().fileManager,callback=function()e.drawOldPixels(m)dofile("/apps/fileManager.lua")drawWorkTable()end},{y=20,name=i.getLanguagePackages().monitorOnline,callback=function()dofile("/apps/monitorOnline.lua")c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,70,1," ")c.setBackground(0x000000)c.fill(1,2,80,23," ")drawWorkTable()end},{y=21,name=i.getLanguagePackages().settings,callback=function()k.settings()end},{y=22,name=i.getLanguagePackages().appsLauncher,callback=function()e.drawOldPixels(m)dofile("/apps/appsLauncher.lua")end},{y=23,name=i.getLanguagePackages().reboot,callback=function()a.shutdown(true)end},{y=24,name=i.getLanguagePackages().shutdown,callback=function()a.shutdown()end}}local function z(s)for A=1,#y do if s==y[A].y then return true,y[A].callback end end;return false,function()return false end end;x=e.rememberOldPixels(1,10,15,24)local B=c.setBackground(0xFFFFFF)local C=c.setForeground(0x000000)c.fill(1,10,15,15," ")for A=1,#y do c.set(1,y[A].y,y[A].name)end;c.setForeground(C)c.setBackground(B)while true do local D={d.pull("touch")}if q(1,10,15,24,D[3],D[4])then local E,F=z(D[4])if E then e.drawOldPixels(m)local G=e.rememberOldPixels(1,1,80,25)F()e.drawOldPixels(G)drawWorkTable()break end else c.setForeground(0xFFFFFF)c.setBackground(0x000000)c.fill(1,10,10,15," ")e.drawOldPixels(x)x={}a.pushSignal(table.unpack(D))break end end end;local function H(s,I)local r=Math.floor(n/2-g.len(I)/2)c.set(r,s,I)end;function k.settings()c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.set(1,1,i.getLanguagePackages().settings)c.setBackground(0xCCCCCC)c.fill(1,2,80,23," ")c.setForeground(0xFFFFFF)c.set(1,2,i.getLanguagePackages().language)local J={}local K=false;local function L()J=e.rememberOldPixels(1,2,80,24)c.setBackground(0xCCCCCC)c.setForeground(0xFFFFFF)c.fill(1,2,80,23," ")H(2,i.getLanguagePackages().selLanguage)H(3,"English")H(4,"Русский")while true do local D={d.pull("touch")}if D[4]==3 then i.changeLanguage("en")c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,70,1," ")c.set(1,1,i.getLanguagePackages().settings)c.setBackground(0xCCCCCC)c.fill(1,2,80,23," ")c.setForeground(0xFFFFFF)c.set(1,2,i.getLanguagePackages().language)break elseif D[4]==4 then i.changeLanguage("ru")c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,70,1," ")c.set(1,1,i.getLanguagePackages().settings)c.setBackground(0xCCCCCC)c.fill(1,2,80,23," ")c.setForeground(0xFFFFFF)c.set(1,2,i.getLanguagePackages().language)e.drawOldPixels(J)break elseif D[3]==40 and D[4]==25 then K=true;c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,70,1," ")c.set(1,1,i.getLanguagePackages().settings)c.setBackground(0xCCCCCC)c.fill(1,2,80,23," ")c.setForeground(0xFFFFFF)c.set(1,2,i.getLanguagePackages().language)e.drawOldPixels(J)break elseif D[3]==35 and D[4]==25 then c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,70,1," ")c.set(1,1,i.getLanguagePackages().settings)c.setBackground(0xCCCCCC)c.fill(1,2,80,23," ")c.setForeground(0xFFFFFF)c.set(1,2,i.getLanguagePackages().language)e.drawOldPixels(J)break end end end;while true do local D={d.pull("touch")}if D[4]==2 then L()i.language=i.getLanguage()elseif D[3]==40 and D[4]==25 then break elseif D[3]==35 and D[4]==25 then break end;if K==true then break end;c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,77,1," ")local M=i.getLanguagePackages().power;local N=g.len(M)c.setBackground(0xFFFF00)c.setForeground(0x610B5E)c.set(76-N,1,M)c.setBackground(0x000000)c.setForeground(0xFFFFFF)end end;_G.oldEnergy=100;_G.timerID=100;function statusBar()local b=require("component")local c=b.gpu;local O=Math.floor((a.energy()/a.maxEnergy()+1)*100)local P=string.gsub(string.format("%q",math.floor(a.energy()/a.maxEnergy()*100+1)),"\"","")local N=g.len(P)local Q=c.setBackground(0x610B5E)local R=c.setForeground(0xFFFFFF)c.fill(77,1,80,1," ")c.set(80-N,1,P)c.set(80,1,"%")c.setBackground(Q)c.setForeground(R)if O<6 then require("term").clear()print("Not enough energy! Shutdown tablet... ")require("computer").shutdown()end;if not O==oldEnergy then a.pushSignal("energyChange",oldEnergy,O)end;oldEnergy=O end;local function S()c.setBackground(0x610B5E)c.setForeground(0xFFFFFF)c.fill(1,1,80,1," ")local M=i.getLanguagePackages().power;local N=g.len(M)c.setBackground(0xFFFF00)c.setForeground(0x610B5E)c.set(76-N,1,M)c.setBackground(0x000000)c.setForeground(0xFFFFFF)_G.timerID=d.timer(1,statusBar,math.huge)timerID=_G.timerID end;workTable={}function drawWorkTable()workTable={}j.setColors(0x000000,0xFFFFFF)c.fill(1,2,80,23," ")local function T()local U="/usr/table/"h.makeDirectory(U)local V={}for W in h.list(U)do if h.exists(U..W)and not h.isDirectory(U..W)then table.insert(V,U..W)end end;return V end;local V=T()for A=1,#V do local X=math.ceil(A/4)+1;local n=20;local o=1;local Y=(A-1)*n+1-(X-2)*n*4-1;local Z=X;local _=function()f.clear()return l.execute(V[A])end;local a0=math.floor(math.random()*0xFFFFFF)local a1=0xFFFFFF-a0;j.drawButton(Y+1,Z,n,o,h.name(V[A]),a0,a1)local a2={x=Y,y=Z,w=n,h=o,callback=_}table.insert(workTable,a2)end end;local function a3(a4,a5)return e.universalWindow("auto","auto",60,0xCCCCCC,true,{"CenterText",0x333333,i.getLanguagePackages().update},{"CenterText",0x333333,a4},{"TextField",10,0xCCCCCC,0x333333,0xFF0000,0x00FF00,a5},{"Button",{0x00FF00,0xFF00FF,"Install"},{0xFF0000,0x00FFFF,"Not install"}})end;local function a6()e.prepareToExit()local a7;local a8;if not h.exists("/version.lua")then a7=a3("Please update OS","Please update OS")a8=true else local a4=dofile("/version.lua")i.getFile("https://raw.githubusercontent.com/HeroBrine1st/OpenComputers/master/TabletOS/version.lua","/usr/newVersion.lua")local a9=dofile("/usr/newVersion.lua")h.remove("/usr/newVersion.lua")local aa=a4.version==a9.version;if not aa then a7=a3(a9.version,a9.changelog[i.getLanguage()])a8=true end end;if a8 then j.setColors(0x000000,0xFFFFFF)f.clear()f.setCursor(1,2)if a7[1]=="Install"then local ab=0;local function ac(ad)local ae,af=pcall(b.internet.request,ad)if ae then local ag=""while true do local ah,ai=af.read()if ah then ag=ag..ah;ab=ab+ah:len()j.setColors(0x000000,0xFFFFFF)print("Packet size "..#ah.." received")j.setColors(0xFFFFFF,0x000000)c.fill(1,1,n,1," ")j.centerText(n/2,1,"Installing update...")j.drawProgressBar(1,2,n,0xFF0000,0x00FF00,ab,140000)else if ai then return false,ai else return true,ag end end end else return false,af end end;local function aj(ad,ak)local ae,al=ac(ad)if ae then h.makeDirectory(h.path(ak)or"")h.remove(ak)local am=io.open(ak,"w")if am then am:write(al)am:close()end;return true,al else return false,al end end;local an="https://raw.githubusercontent.com/HeroBrine1st/OpenComputers/master/TabletOS/applications.txt"local ae,string=i.internetRequest(an)if ae then local ao=load("return "..string)local ae,ap=pcall(ao)if ae then for A=1,#ap do aj(ap[A].url,ap[A].path)end else error(ap)end else error(string)end;a.shutdown(true)end end end;a6()S()p()drawWorkTable()listener=function(...)local D={...}if D[3]==1 and D[4]==25 then m=e.rememberOldPixels(1,2,80,24)drawMenu()e.drawOldPixels(m)elseif D[3]==45 and D[4]==25 then d.cancel(timerID)d.ignore("touch",listener)f.clear()while true do local aq,al=xpcall(loadfile("/apps/shell.lua"),function(ar)return tostring(ar).."\n"..debug.traceback()end)if not aq then io.stderr:write((al~=nil and tostring(al)or"unknown error").."\n")io.write("Press any key to continue.\n")os.sleep(0.5)require("event").pull("key")end end end;local M=i.getLanguagePackages().power;local N=g.len(M)if q(76-N,1,76,1,D[3],D[4])then local as=e.rememberOldPixels(1,1,80,25)e.clearScreen(0x000000)e.waitForTouchOrClick()e.drawOldPixels(as)end end;d.listen("touch",listener)OSAPI={}function OSAPI.init()p()if _G.timerActive then d.cancel(timerID)end;S()d.listen("touch",listener)_G.timerActive=true end;function OSAPI.ignoreListeners()d.cancel(timerID)d.ignore("touch",listener)_G.timerActive=false end;_G.OSAPI=OSAPI;while true do local D={d.pull("touch")}for A=1,#workTable do local at=workTable[A]if q(at.x,at.y,at.x+at.w-1,at.y+at.h-1,D[3],D[4])then OSAPI.ignoreListeners()local ae,au,al=i.saveDisplayAndCallFunction(at.callback)drawWorkTable()OSAPI.init()if not au then i.saveDisplayAndCallFunction(e.error,al)end;drawWorkTable()end end end
