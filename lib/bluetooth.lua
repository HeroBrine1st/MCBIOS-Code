local a=require("computer")local b=require("event")local c=require("filesystem")local d=require("component")local e=d.modem;local f={port=61593,state=false,opened=false,name="TabletOS",devices={}}f.listener=function(...)local g={...}if not g[4]==f.port then return end;local h=g[6]if h=="PING"and f.opened then e.send(g[3],f.port,"PONG",f.name)end;if h=="PONG"then a.pushSignal("BLUETOOTH","PONG",g[3],g[7])end end;function f.on()f.state=true;e.open(f.port)b.listen("modem_message",f.listener)end;function f.off()f.state=false;e.close(f.port)b.ignore("modem_message",f.listener)end;function f.open()f.opened=true end;function f.close()f.opened=false end;function f.sendFile(i,j,k)k=k or function()end;if not c.exists(i)or c.isDirectory(i)then return false end;local l=c.name(i)e.send(j,f.port,"SEND_REQUEST",l,f.name)local m=false;local n=false;while not n do local o,o,p,o,o,q=b.pull("modem_message")if q=="REQUEST_ALLOWED"and p==j then n=true;m=true elseif q=="REQUEST_DENIED"and p==j then n=true end end;if m then totalSize=0;e.send(j,f.port,"SEND_START",c.size(i))local r=io.open(i,"r")repeat local s=r:read(128)if s then totalSize=totalSize+128;e.send(j,f.port,"FILE_CHUNK",s)k(size,totalSize)os.sleep(0.1)end until not s;r:close()return true end end;function f.receiveFile(t,u,v)t=t or function()end;u=u or function()end;v=v or function()return true end;while true do local g={b.pull()}if g[6]=="SEND_REQUEST"then local q=v(g[7],g[8])e.send(g[3],f.port,q and"REQUEST_ALLOWED"or"REQUEST_DENIED")if q then while true do local o,o,w,o,o,x,size=b.pull("modem_message")if x=="SEND_START"and w==g[3]then c.remove("/bluetooth/"..g[7])c.makeDirectory("/bluetooth/")local r=io.open("/bluetooth/"..g[7],"w")local totalSize=0;while true do if totalSize==size then r:close()return true end;local y={b.pull(10,"modem_message")}if#y<3 then return false end;if y[3]==g[3]and y[6]=="FILE_CHUNK"then r:write(y[7])totalSize=totalSize+#y[7]u(size,totalSize)end end end end end end end end;function f.scan()if not f.state then f.on()end;e.broadcast(f.port,"PING")local z={}while true do local g={b.pull(5,"modem_message")}if#g<3 then break end;if g[6]=="PONG"then table.insert(z,{address=g[3],name=g[7]})end end;f.devices=z;return z end;return f
